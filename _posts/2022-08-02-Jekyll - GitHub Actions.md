---
icon: jekyll
chapters: jekyll github cms
title: Jekyll - GitHub Actions
tags: jekyll blog github github-pages 
---
# {{page.title}}

---
При создании сайта Jekyll с помощью GitHub Pages стандартный процесс ограничен по соображениям безопасности и для упрощения настройки сайта. Для большего контроля над сборкой и размещения сайта с помощью GitHub Pages вы можете использовать GitHub Actions.

## Преимущества использования

### Контроль над gemset
- **Версии Jekyll** - вместо использования текущей включенной версии 3.9.0, можно использовать любую версию Jekyll . Например 4.2.2, или указать сразу на репозиторий.
- **Плагины** - можно использовать любые плагины Jekyll, независимо от того, находятся ли они в списке поддерживаемых версий, даже файлы *.rb, размещенные в каталоге _plugins сайта.
- **Темы** - хотя использование пользовательской темы возможно без GitHub Actions, но так это проще.

### Управление рабочим процессом
- **Кастомизация** - создав файл рабочего процесса для запуска действий, можно указать пользовательские шаги сборки, использовать переменные среды.
- **Логирование** - журнал сборки виден, и его можно настроить, чтобы он был подробным, поэтому гораздо проще отлаживать ошибки с помощью GitHub Actions.

## Настройка рабочей области

Первое и главное требование — проект Jekyll, размещенный на GitHub.

Далее будет рассмотрена сборка только из основной ветки **main**. Поэтому убеждаемся, что работаем в основной ветке **main**.

Когда GitHub Action создаст ваш сайт, содержимое целевого каталога будет автоматически отправлено в ветку gh-pages с фиксацией, готовой к использованию для обслуживания.

Действие, которое здесь используется, будет создавать (или сбрасывать существующую) ветку gh-pages при каждом успешном развертывании.
Итак, если есть существующая ветка gh-pages, которая используется для развертывания рабочей сборки, убедитесь, что сделана резервная копия содержимого в другой ветке, чтобы при необходимости можно было легко выполнить откат.

Тестовый сайт у нас будет состоять из 3-х файлов: **_сonfig.yml**, **index.md** и **Gemfile**

{% highlight yaml%}
{% raw %}
# _config.yml

title: "Jekyll Actions Demo"
{% endraw %}
{% endhighlight %}

{% highlight html%}
{% raw %}
<!-- index.md -->
---
---

Welcome to My Home Page

{% assign date = '2022-08-06T10:20:00Z' %}

- Начальная дата - {{ date }}
- С временным фильтром - {{ date | timeago }}
{% endraw %}
{% endhighlight %}

{% highlight html%}
{% raw %}
# Gemfile

source 'https://rubygems.org'

gem 'jekyll', '~> 4.2'
gem "webrick", "~> 1.7"

group :jekyll_plugins do
    gem 'jekyll-timeago', '~> 0.13.1'
end

{% endraw %}
{% endhighlight %}

В демо используется Jekyll 4 и плагин. Данный плагин покажет нам, сколько времени прошло с указанной даты до сегодняшнего дня.

## Настройка GitHub Actions

GitHub Actions регистрируется для репозитория с помощью файла YAML в директории **.github/workflows**.

Создадим файл рабочего процесса с названием **github-pages.yml** использую интерфейс GitHub или в ручную в каталоге рабочих процессов. И запишем в него:
{% highlight yaml %}
{% raw %}
name: Build and deploy Jekyll site to GitHub Pages

on:
    push:
        branches:
            - main # или master до Октября 2020

jobs:
    github-pages:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
            - uses: actions/cache@v2
                with:
                    path: vendor/bundle
                    key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile') }}
                    restore-keys: |
                        ${{ runner.os }}-gems-
            - uses: helaili/jekyll-action@2.4.0    # Выбрать любое из Jekyll Actions
                with:                              # Некоторые относительные входы действия
                    token: ${{ secrets.GITHUB_TOKEN }}
{% endraw %}
{% endhighlight %}

Данный рабочий процесс можно описать следующим образом:

- Запуск сборки, используя условие **on.push** только для ветки **main** - это предотвращает перезапись ветки gh-pages GitHub Actions при любых отправках функциональной ветки.
- Имя задания соответствует нашему имени файла YAML: **github-pages**.
- Действие **checkout** заботится о клонировании вашего репозитория.
- **Кэширование** — это оптимизация, позволяющая избежать извлечения и установки gems при каждой сборке.
- Указано выбранное нами действие и номер его версии, это помогает обрабатывать сборку и развертывание.
- Устанавливается ссылка на секретную переменную среды для использования действия. **GITHUB_TOKEN** — это секретный токен, который автоматически инициализируется в начале каждого запуска рабочего процесса.

Вместо использования условия **on.push**, можно запускать сборку по расписанию, используя параметр on.schedule. Например, здесь запуск сборки происходит в полночь, используя синтаксис cron:
{% highlight cron %}
on:
    schedule:
        - cron: "0 0 * * *"
{% endhighlight %}
Обратите внимание, что эта строка должна быть заключена в кавычки, чтобы предотвратить неправильную оценку звездочек.

### Предоставление разрешений

В начале каждого запуска рабочего процесса GitHub автоматически создает уникальный **GITHUB_TOKEN** для использования рабочего процесса. Этот **GITHUB_TOKEN** можно использовать для аутентификации в рабочем процессе.

Если нужен токен, для которого требуются разрешения, недоступные в GITHUB_TOKEN, можно создать токен личного доступа (PAT) и установить его в качестве секрета в репозитории, чтобы это действие было отправлено в ветку gh-pages.

1. В профиле GitHub в разделе «Настройки разработчика» переходим в раздел «Токены личного доступа».
2. Создаем токен. Даем ему имя, например **«GitHub Actions»**, и убеждаемся, что у него есть        разрешения на public_repos (или всю область репозитория для частного репозитория) — необходимые для того, чтобы действие было зафиксировано в ветке **gh-pages**.
3. Копируем значение токена.
4. Перейдите в настройки репозитория, а затем на вкладку «Secrets».
5. Создайте токен с именем **YOUR_CUSTOM_TOKEN**(важно). Присвойте ему значение, используя значение, скопированное выше.

## Сборка и развертывание

При отправке любых локальных изменений в ветку **main** действие будет запущено, и сборка начнется.

Чтобы следить за ходом выполнения и видеть любые ошибки сборки, проверьте состояние сборки, используя один из следующих подходов:

- **Просмотр коммитов**  
    Перейдите к просмотру репозитория в GitHub. Под самой последним коммитом(вверху) будет виден символ состояния рядом с сообщением о фиксации в виде галочки или Х. Нужно навести на него курсор и щелкнуть для просмотра подробностей.

- **Вкладка "Actions"**  
    Переходим в репозиторий во вкладку "Actions" и выбираем вкладку рабочего процесса Jekyll.